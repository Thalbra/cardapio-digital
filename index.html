<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Card√°pio Digital Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS CORE */
        :root { --primary: #059669; --bg: #f8fafc; --surface: #ffffff; }
        body { background-color: var(--bg); font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Utilit√°rios de Interface */
        .btn-main { background-color: var(--primary); color: white; transition: transform 0.1s; }
        .btn-main:active { transform: scale(0.98); }
        .card-selected { border: 3px solid var(--primary) !important; background-color: #f0fdf4 !important; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Spinner de Carregamento */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800">

    <main class="max-w-md mx-auto min-h-screen pb-32 bg-[var(--surface)] shadow-2xl relative">
        
        <header id="app-banner" class="h-56 bg-gray-200 bg-cover bg-center relative shadow-lg">
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
            <div class="absolute bottom-4 left-6 text-white">
                <h1 id="app-name" class="text-3xl font-black tracking-tight leading-none drop-shadow-md">Carregando...</h1>
                <a id="app-insta" href="#" target="_blank" class="text-xs font-bold bg-white/20 backdrop-blur-md px-3 py-1 rounded-full mt-2 inline-block hover:bg-white/30 transition">
                    üì∏ Instagram Oficial
                </a>
            </div>
        </header>

        <div class="px-6 py-6">
            <div class="mb-8">
                <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Seu Nome</label>
                <input type="text" id="client-name" class="w-full p-4 text-lg bg-gray-50 border border-gray-200 rounded-xl focus:border-[var(--primary)] outline-none font-bold placeholder-gray-300" placeholder="Digite seu nome aqui...">
            </div>

            <div class="flex justify-between items-end mb-4 border-b pb-2">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">Card√°pio</h2>
                    <p class="text-xs text-gray-500">Toque na foto para escolher</p>
                </div>
                <button id="btn-reset" onclick="resetOrder()" class="hidden text-xs font-bold text-red-500 bg-red-50 px-3 py-2 rounded-lg">
                    ‚úï Cancelar Sele√ß√£o
                </button>
            </div>

            <div id="pratos-grid" class="space-y-4"></div>

            <div id="acc-area" class="hidden mt-8 fade-in">
                <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                    <span class="bg-[var(--primary)] w-2 h-6 rounded-full block"></span>
                    Acompanhamentos
                </h3>
                <div id="acc-list" class="grid grid-cols-1 gap-2"></div>
            </div>
        </div>

        <div class="fixed bottom-0 w-full max-w-md bg-white/90 backdrop-blur border-t p-4 z-50">
            <button id="btn-send" onclick="submitOrder()" disabled class="w-full py-4 rounded-xl font-black text-lg uppercase tracking-widest shadow-lg transition-all opacity-50 bg-gray-400 text-white cursor-not-allowed">
                Fazer Pedido
            </button>
        </div>
    </main>

    <div id="admin-modal" class="hidden fixed inset-0 z-[9999] bg-black/50 backdrop-blur-sm overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden">
                
                <div class="bg-slate-900 p-6 flex justify-between items-center text-white">
                    <div>
                        <h2 class="text-2xl font-bold">Painel de Controle</h2>
                        <p class="text-xs text-slate-400">v6.0 Enterprise Edition</p>
                    </div>
                    <button onclick="toggleAdmin(false)" class="text-sm font-bold bg-white/10 px-4 py-2 rounded-lg hover:bg-red-600 transition">FECHAR</button>
                </div>

                <div class="p-6 space-y-8">
                    
                    <section class="space-y-4 border-b pb-6">
                        <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest">Identidade Visual</h3>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="label-admin">Nome do Restaurante</label>
                                <input type="text" id="adm-name" class="input-admin">
                            </div>
                            <div>
                                <label class="label-admin">Link do Instagram</label>
                                <input type="text" id="adm-insta" class="input-admin">
                            </div>
                            <div>
                                <label class="label-admin">Cor Principal</label>
                                <input type="color" id="adm-color" class="w-full h-10 rounded cursor-pointer">
                            </div>
                            <div>
                                <label class="label-admin">Banner Principal (Topo)</label>
                                <input type="file" accept="image/*" onchange="compressAndPreview(this, 'banner-preview', 'adm-banner-data')" class="text-xs w-full">
                                <input type="hidden" id="adm-banner-data">
                                <img id="banner-preview" class="h-12 w-full object-cover mt-2 rounded bg-gray-100">
                            </div>
                        </div>
                    </section>

                    <section>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest">Card√°pio (Ilimitado)</h3>
                            <button onclick="addNewDish()" class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full font-bold hover:bg-green-200">
                                + Adicionar Prato
                            </button>
                        </div>
                        
                        <div id="adm-dishes-list" class="space-y-4"></div>
                    </section>

                    <div class="pt-4 sticky bottom-0 bg-white border-t">
                        <button id="btn-save-admin" onclick="saveSystemData()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-lg hover:bg-black shadow-xl">
                            SALVAR ALTERA√á√ïES
                        </button>
                        <p id="save-status" class="text-center text-xs mt-2 text-gray-400 h-4"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div onclick="adminAuth()" class="fixed top-0 right-0 w-16 h-16 z-50 cursor-default"></div>

    <script>
        // ============================================================
        // ‚öôÔ∏è CONFIGURA√á√ÉO BACKEND
        // ============================================================
        const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbzaOMq4-v2vqsjS1USBrupBqMoGQlRLGUiPdGaC-OM1XolaQ1YosBF563Ylz26f6QSSiQ/exec"; // <--- ATEN√á√ÉO AQUI
        const DB_KEY = "APP_MENU_V6_ENTERPRISE";

        // Estado Global da Aplica√ß√£o
        let appData = {
            meta: {
                name: "Seu Restaurante",
                insta: "https://instagram.com",
                color: "#059669",
                banner: "" // Base64 String
            },
            menu: [] // Array din√¢mico de pratos
        };

        let currentOrder = {
            dish: null,
            sides: []
        };

        // ============================================================
        // üöÄ CORE FUNCTIONS (Inicializa√ß√£o)
        // ============================================================
        window.onload = () => {
            loadData();
            renderApp();
            document.getElementById('client-name').addEventListener('input', validateButton);
        };

        function loadData() {
            const saved = localStorage.getItem(DB_KEY);
            if (saved) {
                try {
                    appData = JSON.parse(saved);
                } catch (e) {
                    console.error("Erro critico no load, resetando db");
                    localStorage.removeItem(DB_KEY);
                }
            } else {
                // Dados Iniciais (Exemplo) se estiver vazio
                addNewDishToState("Prato Exemplo", "Arroz, Feij√£o, Salada");
            }
        }

        function renderApp() {
            // 1. Aplicar Cores e Textos
            document.documentElement.style.setProperty('--primary', appData.meta.color);
            document.getElementById('app-name').innerText = appData.meta.name;
            document.getElementById('app-insta').href = appData.meta.insta;
            
            if (appData.meta.banner && appData.meta.banner.length > 100) {
                document.getElementById('app-banner').style.backgroundImage = `url('${appData.meta.banner}')`;
            }

            // 2. Renderizar Lista de Pratos
            const grid = document.getElementById('pratos-grid');
            grid.innerHTML = "";

            if (appData.menu.length === 0) {
                grid.innerHTML = `<div class="text-center p-8 text-gray-400">Nenhum prato cadastrado. Acesse o Admin.</div>`;
                return;
            }

            appData.menu.forEach((dish, index) => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 cursor-pointer hover:shadow-md transition-all";
                div.id = `dish-card-${index}`;
                div.onclick = () => selectDish(index);

                // Imagem padr√£o se n√£o tiver
                const imgUrl = dish.img && dish.img.length > 50 ? dish.img : "https://via.placeholder.com/150?text=Sem+Foto";

                div.innerHTML = `
                    <img src="${imgUrl}" class="w-20 h-20 rounded-xl object-cover bg-gray-100 shrink-0">
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-800 leading-tight">${dish.name}</h3>
                        <p class="text-[10px] text-gray-400 mt-1 uppercase tracking-wider font-bold">Selecionar</p>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        // ============================================================
        // üõçÔ∏è L√ìGICA DE PEDIDOS (Frontend)
        // ============================================================
        function selectDish(index) {
            currentOrder.dish = appData.menu[index];
            currentOrder.sides = [];

            // UI Feedback
            document.querySelectorAll('[id^="dish-card-"]').forEach(el => el.classList.add('hidden'));
            const selected = document.getElementById(`dish-card-${index}`);
            selected.classList.remove('hidden');
            selected.classList.add('card-selected');

            document.getElementById('btn-reset').classList.remove('hidden');
            
            // Renderizar Acompanhamentos
            const accArea = document.getElementById('acc-area');
            const accList = document.getElementById('acc-list');
            accArea.classList.remove('hidden');
            
            // Tratamento de String para Array (separado por virgula)
            const sidesArray = currentOrder.dish.sides.split(',').map(s => s.trim()).filter(s => s !== "");

            accList.innerHTML = sidesArray.map(side => `
                <label class="flex items-center p-3 bg-white border rounded-xl cursor-pointer hover:bg-gray-50">
                    <input type="checkbox" onchange="toggleSide('${side}')" class="w-5 h-5 rounded text-[var(--primary)] focus:ring-[var(--primary)]">
                    <span class="ml-3 text-sm font-medium text-gray-700">${side}</span>
                </label>
            `).join('');

            validateButton();
        }

        function toggleSide(name) {
            const i = currentOrder.sides.indexOf(name);
            if (i > -1) currentOrder.sides.splice(i, 1);
            else currentOrder.sides.push(name);
            validateButton();
        }

        function resetOrder() {
            currentOrder = { dish: null, sides: [] };
            document.querySelectorAll('[id^="dish-card-"]').forEach(el => {
                el.classList.remove('hidden');
                el.classList.remove('card-selected');
            });
            document.getElementById('btn-reset').classList.add('hidden');
            document.getElementById('acc-area').classList.add('hidden');
            validateButton();
        }

        function validateButton() {
            const name = document.getElementById('client-name').value.trim();
            const btn = document.getElementById('btn-send');
            
            const isValid = name.length > 2 && currentOrder.dish !== null && currentOrder.sides.length > 0;

            if (isValid) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'bg-gray-400', 'cursor-not-allowed');
                btn.classList.add('btn-main', 'cursor-pointer');
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'bg-gray-400', 'cursor-not-allowed');
                btn.classList.remove('btn-main', 'cursor-pointer');
            }
        }

        async function submitOrder() {
            const btn = document.getElementById('btn-send');
            const originalText = btn.innerText;
            
            btn.innerHTML = "<span class='loader'></span> Enviando...";
            btn.disabled = true;

            const payload = {
                nome: document.getElementById('client-name').value,
                prato: currentOrder.dish.name,
                acompanhamentos: currentOrder.sides.join(', '),
                data: new Date().toLocaleString('pt-BR')
            };

            try {
                await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                alert("‚úÖ Pedido Recebido com Sucesso!");
                location.reload();
            } catch (error) {
                alert("Erro de conex√£o. Tente novamente.");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // ============================================================
        // üõ°Ô∏è ADMINISTRA√á√ÉO PROFISSIONAL
        // ============================================================
        function adminAuth() {
            if (prompt("Senha de Acesso:") === "123") {
                toggleAdmin(true);
                populateAdmin();
            }
        }

        function toggleAdmin(show) {
            const modal = document.getElementById('admin-modal');
            show ? modal.classList.remove('hidden') : modal.classList.add('hidden');
        }

        // Renderiza o formul√°rio do Admin com os dados atuais
        function populateAdmin() {
            document.getElementById('adm-name').value = appData.meta.name;
            document.getElementById('adm-insta').value = appData.meta.insta;
            document.getElementById('adm-color').value = appData.meta.color;
            document.getElementById('adm-banner-data').value = appData.meta.banner;
            document.getElementById('banner-preview').src = appData.meta.banner || "";

            const list = document.getElementById('adm-dishes-list');
            list.innerHTML = ""; // Limpa lista

            appData.menu.forEach((dish, index) => {
                const item = document.createElement('div');
                item.className = "bg-slate-50 p-4 rounded-xl border border-slate-200 relative";
                item.innerHTML = `
                    <button onclick="removeDish(${index})" class="absolute top-2 right-2 text-red-500 font-bold text-xs hover:bg-red-100 p-1 rounded">EXCLUIR</button>
                    <div class="space-y-3">
                        <div>
                            <label class="label-admin">Nome do Prato</label>
                            <input type="text" value="${dish.name}" id="adm-dish-name-${index}" class="input-admin font-bold">
                        </div>
                        <div class="flex gap-3">
                            <div class="w-20">
                                <img src="${dish.img || ''}" id="prev-d-${index}" class="w-16 h-16 rounded object-cover bg-gray-200 block mb-1">
                                <input type="file" onchange="compressAndPreview(this, 'prev-d-${index}', 'val-d-${index}')" class="text-[10px] w-full">
                                <input type="hidden" id="val-d-${index}" value="${dish.img || ''}">
                            </div>
                            <div class="flex-1">
                                <label class="label-admin">Acompanhamentos (Separados por v√≠rgula)</label>
                                <textarea id="adm-dish-acc-${index}" class="input-admin h-20 text-xs">${dish.sides}</textarea>
                            </div>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // Fun√ß√£o para adicionar novo prato ao State e re-renderizar Admin
        function addNewDish() {
            addNewDishToState("Novo Prato", "Arroz, Feij√£o");
            populateAdmin(); // Atualiza a tela
        }

        function addNewDishToState(name, sides) {
            appData.menu.push({
                name: name,
                img: "",
                sides: sides
            });
        }

        function removeDish(index) {
            if (confirm("Tem certeza que deseja excluir este prato?")) {
                appData.menu.splice(index, 1);
                populateAdmin();
            }
        }

        // Salvar tudo
        function saveSystemData() {
            const btn = document.getElementById('btn-save-admin');
            const status = document.getElementById('save-status');
            
            btn.innerText = "Salvando...";
            
            // 1. Capturar Meta
            appData.meta.name = document.getElementById('adm-name').value;
            appData.meta.insta = document.getElementById('adm-insta').value;
            appData.meta.color = document.getElementById('adm-color').value;
            appData.meta.banner = document.getElementById('adm-banner-data').value;

            // 2. Capturar Pratos da Tela (para pegar edi√ß√µes de texto)
            appData.menu.forEach((dish, index) => {
                const nameInput = document.getElementById(`adm-dish-name-${index}`);
                const accInput = document.getElementById(`adm-dish-acc-${index}`);
                const imgInput = document.getElementById(`val-d-${index}`); // Hidden field

                if (nameInput) dish.name = nameInput.value;
                if (accInput) dish.sides = accInput.value;
                if (imgInput) dish.img = imgInput.value;
            });

            // 3. Persistir
            try {
                localStorage.setItem(DB_KEY, JSON.stringify(appData));
                status.innerText = "Dados salvos com sucesso!";
                btn.innerText = "SALVAR ALTERA√á√ïES";
                setTimeout(() => location.reload(), 500);
            } catch (e) {
                console.error(e);
                alert("Erro: Limite de armazenamento excedido. Tente usar imagens menores.");
                btn.innerText = "ERRO AO SALVAR";
            }
        }

        // ============================================================
        // üîß ENGINE DE IMAGENS (COMPRESS√ÉO)
        // ============================================================
        function compressAndPreview(input, imgPreviewId, hiddenInputId) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    const img = new Image();
                    img.src = event.target.result;
                    
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Configura√ß√£o de Compress√£o (Max 800px width)
                        const maxWidth = 800;
                        const scaleSize = maxWidth / img.width;
                        const newWidth = maxWidth;
                        const newHeight = img.height * scaleSize;

                        canvas.width = newWidth;
                        canvas.height = newHeight;
                        
                        ctx.drawImage(img, 0, 0, newWidth, newHeight);
                        
                        // Converte para JPEG com qualidade 0.7 (70%)
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        
                        // Atualiza UI
                        document.getElementById(imgPreviewId).src = compressedBase64;
                        document.getElementById(hiddenInputId).value = compressedBase64;
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        // CSS Helpers for Admin Input
        const style = document.createElement('style');
        style.innerHTML = `
            .label-admin { display:block; font-size: 10px; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }
            .input-admin { width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; outline: none; transition: border-color 0.2s; }
            .input-admin:focus { border-color: var(--primary); }
        `;
        document.head.appendChild(style);

    </script>
</body>
</html>
